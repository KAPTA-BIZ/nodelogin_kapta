<!DOCTYPE html>
<html lang="en">
   <head>
      <title>Busqueda Consultor</title>
      <% include partials/head %>
   <body>
      <% include partials/left_column %>
      <div class="main-panel">
         <% include partials/navbar %>
         <div class="content">
            <strong>Consultor</strong> : <% iduser=user.local.email %><%= iduser %> <br>   <br>
            <div class="container-fluid">
               <div class="row">
                  <div class="col-5" style="margin: 20px;" >
                     <form action="/searchandlink" method="GET">
                        <label for="exampleInputEmail1">Buscar por categoria</label><br>
                        <select name="search" class="custom-select mb-2 mr-sm-2 mb-sm-0" id="inlineFormCustomSelect">
                           <% a = [] 
                              result.forEach(function(items){ 
                                 if(items.category_results){ 
                                    long=(items.category_results.length)
                                       for(i=0; i<long; i++){ 
                                          if(!a.includes(items.category_results[i].name)){
                                             a.push(items.category_results[i].name)
                                          }
                                          %>
                           <% } %>  
                           <% } %>
                           <% } )%>
                           <%for(i=0;i<a.length;i++){%>
                           <option value="<%= a[i] %>"><%= a[i] %></option>
                           <% } %>
                        </select>
                        <input type="text" value="<%= url %>" name="id" style="display:none">
                        <input type="text" name="start"  value="<%= date_start %>" style="display:none">
                        <input type="text" name="end"  value="<%= date_end  %>" style="display:none">
                        <%if(typeof busqueda_get !== "undefined"){%>
                        <input type="text" name="busqueda_get"  value="<%= busqueda_get  %>" style="display:none">
                        <% } %>
                        <button type="submit" class="btn btn-primary">Buscar</button>
                     </form>
                     <br>
                  </div>
                  <div class="col-6" style="margin: 20px;" >
                     <form action="/searchandlink" method="GET">
                        <label for="exampleInputEmail1">Buscar por fecha</label>
                        <br/>
                        <div class="input-daterange input-group" id="datepicker">
                           <div class="input-group-addon">Desde</div>
                           <input type="text" id="from" name="start" required="" style="width: 20%;">
                           <div class="input-group-addon">Hasta</div>
                           <input type="text" id="to" name="end" required="" style="width: 20%;">
                           <input type="text" value="<%= url %>" name="id" style="display:none">
                           <!--categoria seleccionada -->
                           <input type="text" value="<%= cat_search %>" name="search" style="display:none">
                           <%if(typeof busqueda_get !== "undefined"){%>
                           <input type="text" name="busqueda_get"  value="<%= busqueda_get  %>" style="display:none">
                           <% } %>
                           <button type="submit" class="btn btn-primary" style="margin-left: 10px;">Buscar</button>
                        </div>
                     </form>
                     <script>
                        $( function() {
                          var dateFormat = "yyyy-mm-dd",
                            from = $( "#from" )
                              .datepicker({
                                dateFormat: "yy-mm-dd",
                                defaultDate: "+1w",
                                changeMonth: true,
                                numberOfMonths: 1
                              })
                              .on( "change", function() {
                                to.datepicker( "option", "minDate", getDate( this ) );
                              }),
                            to = $( "#to" ).datepicker({
                              dateFormat: "yy-mm-dd",
                              defaultDate: "+1w",
                              changeMonth: true,
                              numberOfMonths: 1
                            })
                            .on( "change", function() {
                              from.datepicker( "option", "maxDate", getDate( this ) );
                            });
                        
                          function getDate( element ) {
                            var date;
                            console.log(element.value)
                            try {
                              date = $.datepicker.parseDate( dateFormat, element.value );
                            } catch( error ) {
                              date = null;
                            }
                            return date;
                          }
                        } );
                     </script>
                  </div>
                  <div class="col-md-12">
                   <%if(url==user.id){%>
                   <%if(typeof busqueda_get !== 'undefined' ){%>
                   <a href="/consultor_search?search=<%=busqueda_get%>&id_inst=<%=url%>">Restablecer Búsqueda</a>
                   <% } %>
                    <% }else{ %>
                    <a href="/list_test/<%=url%>&<%=user.id%>">Restablecer Búsqueda</a>
                    <% } %>
                    <br><br>
                     <div class="card strpied-tabled-with-hover">
                        <div class="card-header ">
                           <h4 class="card-title">
                              <% if(link[0]) { %>Evaluación: <%= link[0].link_name %><% } %>
                           </h4>
                           <%
                              var date_s=''
                              var date_e=''
                              const isset_s = (date_start) => typeof date_start !== 'undefined' 
                              typeof date_start=='undefined'?date_s='':date_s=date_start
                              const isset_e = (date_end) => typeof date_end !== 'undefined' 
                              typeof date_end=='undefined'?date_e='':date_e=date_end
                              %>
                           <%if((date_s&&date_e)!=''){%>
                           <p>Busqueda realizada entre <%= date_s %> y <%= date_e %></p>
                           <%}else{%>
                           <p></p>
                           <%}%>
                           <!-- Search Bar Start -->
                           <!--<form action="/consultor_search">
                              <h3>Barra de busqueda.</h3>
                              <div class="form-group row" >
                              <div class="col-8">
                                  <%
                                 var busq=''
                                 const isset = (busqueda) => typeof busqueda !== 'undefined' 
                                 typeof busqueda=='undefined'?busq='':busq=busqueda
                                 %>
                                <input class="form-control" type="search" name="search" placeholder="Buscar link o test o access code" value="<%= busq  %>" required/>
                              </div>
                              <div class="col-2">
                                <button class="btn btn-light">Buscar</button>
                              </div>
                              </div>
                              </form>-->
                           <!-- Search Bar End -->
                           <div class="card-body table-full-width table-responsive">
                              <table class="table table-hover table-striped">
                                 <thead>
                                    <tr>
                                       <th>Código de acceso</th>
                                       <th>Porcentaje</th>
                                       <th>Categoría(s)</th>
                                       <th>Fecha</th>
                                       <th></th>
                                 </thead>
                                 <tbody>
                                    <% result.forEach(function(items) { %>
                                    <% for(i=0; i<items.category_results.length; i++){ %>
                                    <% if(cat_search==items.category_results[i].name){ %>
                                    <tr>
                                       <td><%= items.access_code %></td>
                                       <td>
                                          <%= items.category_results[i].percentage %>%
                                       </td>
                                       <td>
                                          <%=cat_search%>
                                       </td>
                                       <td>
                                          <% function timeConverter(UNIX_timestamp)
                                             {
                                                var a = new Date(UNIX_timestamp * 1000);
                                                var months = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
                                                var year = a.getFullYear();
                                                var month = months[a.getMonth()];
                                                var date = a.getDate();
                                                var hour = a.getHours();
                                                var min = a.getMinutes();
                                                var sec = a.getSeconds();
                                                var time = date + ' ' + month + ' ' + year + ' ' + hour + ':' + min + ':' + sec ;
                                                return time;
                                             }
                                             %><%= timeConverter(items.time_started) %>
                                       </td>
                                       <td><a href="viewinfo/<%=items.access_code%>">Ver detalles</a></td>
                                    </tr>
                                    <% } } %>  
                                    <% }); %>
                                 </tbody>
                              </table>
                           </div>
                           
                           <div class="card strpied-tabled-with-hover">
                            <div class="card-header ">
                                <h4 class="card-title">Categorías presentadas</h4>
                            </div>
                            <div class="card-body table-full-width table-responsive">
                                <canvas id="category_chart" height="400" width="900"></canvas>
                            </div>
                           </div>
                           <!-- captura promedio porcentaje categoria -->
                           
                           <% promedio_cat = [] %>
                           <% var promedio=0 %>
                           <% var aux=0, count=0, total=0 %>
                           <% result.forEach(function(items) { %>
                           
                           
                              <% for(i=0; i<items.category_results.length; i++){ %>
                                 <% if(cat_search==items.category_results[i].name){ %>
                                    <% items.category_results[i].percentage %>
                                    <% promedio=items.category_results[i].percentage 
                                     aux = aux + promedio 
                                     count+=1 %>
                              <% } %> 
                           <% } %>
                           <% }) %>
                           
                           <%total=(aux/count).toFixed(2)%>
                           <!-- captura promedio porcentaje categoria -->
                        </div>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      </div>
      
      <!-- grafica por categoria -->
       <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.bundle.js"></script>
      <script>
           var test_a = <%-JSON.stringify(total) %>; 
   
           new Chart(document.getElementById("category_chart"), {
               type: 'bar',
               data: {
               labels: ['<%=cat_search %>'],
               datasets: [
                   {
                   label: "% Promedio por categoría",
                   backgroundColor: "#FF8000",
                   data: [test_a],
                   }
                   ]},
               options: {
               title: {
                   display: false,
                   text: 'Resultados Participante y Categorías'
               },
               scales: {
                   xAxes: [{
                       barThickness : 63
                   }],
                   yAxes: [{
                          display: true,
                          ticks: {
                          stepSize: 25,
                          max: 100,
                          min: 0
                          }
                      }],
                      
               }
           }
           });
       </script>
   </body>
</html>